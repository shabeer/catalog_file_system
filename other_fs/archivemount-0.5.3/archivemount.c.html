<html>
<head>
  <title>archivemount.c</title>
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>
<font color="#444444">/*

   Copyright (c) 2005 Andre Landwehr &lt;andrel@cybernoia.de&gt;

   This program can be distributed under the terms of the GNU GPL.
   See the file COPYING.

   Based on: fusexmp.c by Miklos Szeredi

*/</font>

<font color="0000ff"><strong>#define VER_MAJOR 0</strong></font>
<font color="0000ff"><strong>#define VER_MINOR 5</strong></font>
<font color="0000ff"><strong>#define VER_RELEASE 3</strong></font>

<font color="0000ff"><strong>#ifdef linux</strong></font>
<font color="#444444">/* For pread()/pwrite() */</font>
<font color="0000ff"><strong>#define _XOPEN_SOURCE 500</strong></font>
<font color="0000ff"><strong>#define _GNU_SOURCE 1</strong></font>
<font color="0000ff"><strong>#endif</strong></font>

<font color="0000ff"><strong>#define FUSE_USE_VERSION 22</strong></font>
<font color="0000ff"><strong>#define MAXBUF 4096</strong></font>

<font color="0000ff"><strong>#include <font color="#008000">&lt;fuse.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;stdio.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;stdlib.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;string.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;stdarg.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;unistd.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;fcntl.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;dirent.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;errno.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;sys/statfs.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;sys/types.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;sys/stat.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;time.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;grp.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;pwd.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;utime.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;string.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;wchar.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;archive.h&gt;</font></strong></font>
<font color="0000ff"><strong>#include <font color="#008000">&lt;archive_entry.h&gt;</font></strong></font>

  <font color="#444444"><i>/**********/</i></font>
 <font color="#444444">/* macros */</font>
<font color="#444444"><i>/**********/</i></font>
<font color="0000ff"><strong>#ifdef NDEBUG</strong></font>
<font color="0000ff"><strong>#   define log(format, ...)</strong></font>
<font color="0000ff"><strong>#else</strong></font>
<font color="0000ff"><strong>#   define log(format, ...) \</strong></font>
<font color="4444FF"><strong>{</strong></font> \
	<font color="#2040a0">FILE</font> <font color="4444FF">*</font><font color="#2040a0">FH</font> <font color="4444FF">=</font> <font color="#2040a0">fopen</font><font color="4444FF">(</font> <font color="#008000">&quot;/tmp/archivemount.log&quot;</font>, <font color="#008000">&quot;a&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font> \
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">FH</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font> \
		<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">FH</font>, <font color="#008000">&quot;l. %4d: &quot;</font> <font color="#2040a0">format</font> <font color="#008000">&quot;<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">__LINE__</font>, ##<font color="#2040a0">__VA_ARGS__</font> <font color="4444FF">)</font><font color="4444FF">;</font> \
		<font color="#2040a0">fclose</font><font color="4444FF">(</font> <font color="#2040a0">FH</font> <font color="4444FF">)</font><font color="4444FF">;</font> \
	<font color="4444FF"><strong>}</strong></font> \
<font color="4444FF"><strong>}</strong></font>
<font color="0000ff"><strong>#endif</strong></font>

  <font color="#444444"><i>/*******************/</i></font>
 <font color="#444444">/* data structures */</font>
<font color="#444444"><i>/*******************/</i></font>

<strong>typedef</strong> <strong>struct</strong> <font color="#2040a0">node</font> <font color="4444FF"><strong>{</strong></font>
	<strong>struct</strong> <font color="#2040a0">node</font> <font color="4444FF">*</font><font color="#2040a0">parent</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">node</font> <font color="4444FF">*</font><font color="#2040a0">prev</font><font color="4444FF">;</font> <font color="#444444">/* previous in same directory */</font>
	<strong>struct</strong> <font color="#2040a0">node</font> <font color="4444FF">*</font><font color="#2040a0">next</font><font color="4444FF">;</font> <font color="#444444">/* next in same directory */</font>
	<strong>struct</strong> <font color="#2040a0">node</font> <font color="4444FF">*</font><font color="#2040a0">child</font><font color="4444FF">;</font> <font color="#444444">/* first child for directories */</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">name</font><font color="4444FF">;</font> <font color="#444444">/* fully qualified with prepended '/' */</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">location</font><font color="4444FF">;</font> <font color="#444444">/* location on disk for new/modified files, else NULL */</font>
	<strong>int</strong> <font color="#2040a0">namechanged</font><font color="4444FF">;</font> <font color="#444444">/* true when file was renamed */</font>
	<strong>struct</strong> <font color="#2040a0">archive_entry</font> <font color="4444FF">*</font><font color="#2040a0">entry</font><font color="4444FF">;</font> <font color="#444444">/* libarchive header data */</font>
	<strong>int</strong> <font color="#2040a0">modified</font><font color="4444FF">;</font> <font color="#444444">/* true when node was modified */</font>
<font color="4444FF"><strong>}</strong></font> <font color="#2040a0">NODE</font><font color="4444FF">;</font>


  <font color="#444444"><i>/***********/</i></font>
 <font color="#444444">/* globals */</font>
<font color="#444444"><i>/***********/</i></font>

<strong>static</strong> <strong>int</strong> <font color="#2040a0">archiveFd</font><font color="4444FF">;</font> <font color="#444444">/* file descriptor of archive file, just to keep the
			 beast alive in case somebody deletes the file while
			 it is mounted */</font>
<strong>static</strong> <strong>int</strong> <font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<strong>static</strong> <strong>int</strong> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<strong>static</strong> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">root</font><font color="4444FF">;</font>


  <font color="#444444"><i>/**********************/</i></font>
 <font color="#444444">/* internal functions */</font>
<font color="#444444"><i>/**********************/</i></font>

<strong>static</strong> <strong>void</strong>
<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">parent</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">namechanged</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>void</strong>
<font color="#2040a0">remove_child</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">parent</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">parent</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>void</strong>
<font color="#2040a0">insert_as_child</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font>, <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">parent</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">parent</font> <font color="4444FF">=</font> <font color="#2040a0">parent</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">parent</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">parent</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* find last child of parent, insert node behind it */</font>
		<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">b</font> <font color="4444FF">=</font> <font color="#2040a0">parent</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font><font color="4444FF">;</font>
		<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">b</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">b</font> <font color="4444FF">=</font> <font color="#2040a0">b</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">b</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">;</font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">prev</font> <font color="4444FF">=</font> <font color="#2040a0">b</font><font color="4444FF">;</font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;inserted '%s' as child of '%s'&quot;</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#2040a0">parent</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444">/*
 * inserts &quot;node&quot; into tree starting at &quot;root&quot; according to the path
 * specified in node-&gt;name
 * @return 0 on success, 0-errno else (ENOENT or ENOTDIR)
 */</font>
<strong>static</strong> <strong>int</strong>
<font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">root</font>, <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">temp</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">cur</font> <font color="4444FF">=</font> <font color="#2040a0">root</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">key</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">;</font>

	<font color="#2040a0">key</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
	<strong>while</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">temp</font> <font color="4444FF">=</font> <font color="#2040a0">strchr</font><font color="4444FF">(</font> <font color="#2040a0">key</font>, <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">size_t</font> <font color="#2040a0">namlen</font> <font color="4444FF">=</font> <font color="#2040a0">temp</font> <font color="4444FF">-</font> <font color="#2040a0">key</font><font color="4444FF">;</font>
		<strong>char</strong> <font color="#2040a0">nam</font><font color="4444FF">[</font><font color="#2040a0">namlen</font> <font color="4444FF">+</font> <font color="#FF0000">1</font><font color="4444FF">]</font><font color="4444FF">;</font>
		<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">last</font> <font color="4444FF">=</font> <font color="#2040a0">cur</font><font color="4444FF">;</font>

		<font color="#2040a0">strncpy</font><font color="4444FF">(</font> <font color="#2040a0">nam</font>, <font color="#2040a0">key</font>, <font color="#2040a0">namlen</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">nam</font><font color="4444FF">[</font><font color="#2040a0">namlen</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#008000">'<font color="#77dd77">\0</font>'</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">strrchr</font><font color="4444FF">(</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">1</font>, <font color="#2040a0">nam</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">cur</font> <font color="4444FF">=</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font><font color="4444FF">;</font>
			<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">cur</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">strrchr</font><font color="4444FF">(</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">1</font>,
						<font color="#2040a0">nam</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
			<font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">cur</font> <font color="4444FF">=</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">cur</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* parent path not found, create a temporary one */</font>
			<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">tempnode</font><font color="4444FF">;</font>
			<font color="#2040a0">tempnode</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font> <strong>sizeof</strong><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">tempnode</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">tempnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font>
					<font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">last</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#2040a0">namlen</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">last</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">root</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="#2040a0">tempnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">&quot;%s/%s&quot;</font>, <font color="#2040a0">last</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#2040a0">nam</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="#2040a0">tempnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">&quot;/%s&quot;</font>, <font color="#2040a0">nam</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
			<font color="#2040a0">tempnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_clone</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#444444">/* insert it recursively */</font>
			<font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">tempnode</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#444444">/* now inserting node should work, correct cur for it */</font>
			<font color="#2040a0">cur</font> <font color="4444FF">=</font> <font color="#2040a0">tempnode</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* iterate */</font>
		<font color="#2040a0">key</font> <font color="4444FF">=</font> <font color="#2040a0">temp</font> <font color="4444FF">+</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">S_ISDIR</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* check if a child of this name already exists */</font>
		<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">tempnode</font><font color="4444FF">;</font>
		<strong>int</strong> <font color="#2040a0">found</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
		<font color="#2040a0">tempnode</font> <font color="4444FF">=</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font><font color="4444FF">;</font>
		<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">tempnode</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">strrchr</font><font color="4444FF">(</font> <font color="#2040a0">tempnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">1</font>,
						<font color="#2040a0">strrchr</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font>
					<font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
			<font color="4444FF"><strong>{</strong></font>
				<font color="#444444">/* this is a dupe due to a temporarily inserted
				   node, just update the entry */</font>
				<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_clone</font><font color="4444FF">(</font>
						<font color="#2040a0">tempnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">found</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
				<strong>break</strong><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
			<font color="#2040a0">tempnode</font> <font color="4444FF">=</font> <font color="#2040a0">tempnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">found</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">insert_as_child</font><font color="4444FF">(</font> <font color="#2040a0">node</font>, <font color="#2040a0">cur</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOTDIR</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">build_tree</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">mtpt</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>struct</strong> <font color="#2040a0">archive</font> <font color="4444FF">*</font><font color="#2040a0">archive</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">archive_entry</font> <font color="4444FF">*</font><font color="#2040a0">entry</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">stat</font> <font color="#2040a0">st</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">format</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">compression</font><font color="4444FF">;</font>

	<font color="#444444">/* open archive */</font>
	<font color="#2040a0">archive</font> <font color="4444FF">=</font> <font color="#2040a0">archive_read_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_support_compression_all</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">stderr</font>, <font color="#008000">&quot;%s<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_support_format_all</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">stderr</font>, <font color="#008000">&quot;%s<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_open_fd</font><font color="4444FF">(</font> <font color="#2040a0">archive</font>, <font color="#2040a0">archiveFd</font>, <font color="#FF0000">10240</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">stderr</font>, <font color="#008000">&quot;%s<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* check if format or compression prohibits writability */</font>
	<font color="#2040a0">format</font> <font color="4444FF">=</font> <font color="#2040a0">archive_format</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">compression</font> <font color="4444FF">=</font> <font color="#2040a0">archive_compression</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_ISO9660</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_ISO9660_ROCKRIDGE</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_ZIP</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">compression</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_COMPRESSION_COMPRESS</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archiveWriteable</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* create root node */</font>
	<font color="#2040a0">root</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font> <strong>sizeof</strong><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">root</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#008000">&quot;/&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* fill root-&gt;entry */</font>
	<font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">fstat</font><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">perror</font><font color="4444FF">(</font> <font color="#008000">&quot;Error stat'ing archiveFile&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">errno</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">archive_entry_set_gid</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">getgid</font><font color="4444FF">(</font><font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_gid</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">getuid</font><font color="4444FF">(</font><font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_mode</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_mtime</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#008000">&quot;/&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_size</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_size</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">stat</font><font color="4444FF">(</font> <font color="#2040a0">mtpt</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_mode</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_mode</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* read all entries in archive, create node for each */</font>
	<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_next_header</font><font color="4444FF">(</font> <font color="#2040a0">archive</font>, <font color="4444FF">&amp;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">cur</font><font color="4444FF">;</font>
		<strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">name</font><font color="4444FF">;</font>
		<font color="#444444">/* find name of node */</font>
		<font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strncmp</font><font color="4444FF">(</font> <font color="#2040a0">name</font>, <font color="#008000">&quot;./<font color="#77dd77">\0</font>&quot;</font>, <font color="#FF0000">3</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* special case: the directory &quot;./&quot; must be skipped! */</font>
			<strong>continue</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* create node and clone the entry */</font>
		<font color="#2040a0">cur</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font> <strong>sizeof</strong><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">cur</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_clone</font><font color="4444FF">(</font> <font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#444444">/* normalize the name to start with &quot;/&quot; */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strncmp</font><font color="4444FF">(</font> <font color="#2040a0">name</font>, <font color="#008000">&quot;./&quot;</font>, <font color="#FF0000">2</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* remove the &quot;.&quot; of &quot;./&quot; */</font>
			<font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">name</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">name</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* prepend a '/' to name */</font>
			<font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">name</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">2</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">&quot;/%s&quot;</font>, <font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* just set the name */</font>
			<font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* remove trailing '/' for directories */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">[</font><font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">[</font><font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#008000">'<font color="#77dd77">\0</font>'</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* references */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">cur</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR: could not insert %s into tree&quot;</font>,
					<font color="#2040a0">cur</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">archive_read_data_skip</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* close archive */</font>
	<font color="#2040a0">archive_read_finish</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">lseek</font><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font>, <font color="#FF0000">0</font>, <font color="#2040a0">SEEK_SET</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <font color="#2040a0">NODE</font> <font color="4444FF">*</font>
<font color="#2040a0">find_modified_node</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">start</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">run</font> <font color="4444FF">=</font> <font color="#2040a0">start</font><font color="4444FF">;</font>

	<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">run</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">run</font><font color="4444FF">;</font>
			<strong>break</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">find_modified_node</font><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<strong>break</strong><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">run</font> <font color="4444FF">=</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <font color="#2040a0">NODE</font> <font color="4444FF">*</font>
<font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">start</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">run</font> <font color="4444FF">=</font> <font color="#2040a0">start</font><font color="4444FF">;</font>

	<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">run</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">run</font><font color="4444FF">;</font>
			<strong>break</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">strncmp</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>,
					<font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<strong>break</strong><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">run</font> <font color="4444FF">=</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <font color="#2040a0">NODE</font> <font color="4444FF">*</font>
<font color="#2040a0">get_node_for_entry</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">start</font>, <strong>struct</strong> <font color="#2040a0">archive_entry</font> <font color="4444FF">*</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">run</font> <font color="4444FF">=</font> <font color="#2040a0">start</font><font color="4444FF">;</font>
	<strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">path</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">path</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">run</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">name</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">name</font><font color="4444FF">+</font><font color="4444FF">+</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="#2040a0">name</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">run</font><font color="4444FF">;</font>
			<strong>break</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_entry</font><font color="4444FF">(</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font>, <font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font>
			<font color="4444FF"><strong>{</strong></font>
				<strong>break</strong><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">run</font> <font color="4444FF">=</font> <font color="#2040a0">run</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">rename_recursively</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">start</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">from</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">to</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">individualName</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">newName</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">start</font><font color="4444FF">;</font>

	<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* recurse */</font>
			<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">rename_recursively</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font>, <font color="#2040a0">from</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* change node name */</font>
		<font color="#2040a0">individualName</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">+</font> <font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">from</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">to</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">newName</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <strong>char</strong> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">to</font> <font color="4444FF">)</font> <font color="4444FF">+</font>
					<font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">individualName</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">2</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="#2040a0">newName</font>, <font color="#008000">&quot;/%s%s&quot;</font>, <font color="#2040a0">to</font>, <font color="#2040a0">individualName</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">newName</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <strong>char</strong> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">to</font> <font color="4444FF">)</font> <font color="4444FF">+</font>
					<font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">individualName</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="#2040a0">newName</font>, <font color="#008000">&quot;%s%s&quot;</font>, <font color="#2040a0">to</font>, <font color="#2040a0">individualName</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">newName</font><font color="4444FF">;</font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">namechanged</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
		<font color="#444444">/* iterate */</font>
		<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">get_temp_file_name</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>char</strong> <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">location</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">tmppath</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">fh</font><font color="4444FF">;</font>

	<font color="#444444">/* create name for temp file */</font>
	<font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">tmppath</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>do</strong> <strong>if</strong><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">tmp</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF">*</font><font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#008000">'_'</font><font color="4444FF">;</font> <strong>while</strong><font color="4444FF">(</font> <font color="4444FF">*</font><font color="4444FF">(</font> <font color="#2040a0">tmp</font><font color="4444FF">+</font><font color="4444FF">+</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF">*</font><font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <strong>char</strong> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font>
			<font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">P_tmpdir</font> <font color="4444FF">)</font> <font color="4444FF">+</font>
			<font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#008000">&quot;_archivemount&quot;</font> <font color="4444FF">)</font> <font color="4444FF">+</font>
			<font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">tmppath</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">8</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">location</font>, <font color="#008000">&quot;%s/archivemount%s_XXXXXX&quot;</font>, <font color="#2040a0">P_tmpdir</font>, <font color="#2040a0">tmppath</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">tmppath</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#2040a0">mkstemp</font><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Could not create temp file name %s: %s&quot;</font>,
				<font color="4444FF">*</font><font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444"><i>/**
 * Updates given nodes node-&gt;entry by stat'ing node-&gt;location. Does not update
 * the name!
 */</i></font>
<strong>static</strong> <strong>int</strong>
<font color="#2040a0">update_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>struct</strong> <font color="#2040a0">stat</font> <font color="#2040a0">st</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">passwd</font> <font color="4444FF">*</font><font color="#2040a0">pwd</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">group</font> <font color="4444FF">*</font><font color="#2040a0">grp</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">lstat</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">archive_entry_set_gid</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_gid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_uid</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_uid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_mtime</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_mtime</font>, <font color="#FF0000">0</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_size</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_size</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_mode</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_rdevmajor</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_dev</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_rdevminor</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">st</font>.<font color="#2040a0">st_dev</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">pwd</font> <font color="4444FF">=</font> <font color="#2040a0">getpwuid</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_uid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">pwd</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_uname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">pwd</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">pw_name</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">grp</font> <font color="4444FF">=</font> <font color="#2040a0">getgrgid</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_gid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">grp</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_gname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">grp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">gr_name</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444">/*
 * write a new or modified file to the new archive; used from save()
 */</font>
<strong>static</strong> <strong>void</strong>
<font color="#2040a0">write_new_modded_file</font><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font>, <strong>struct</strong> <font color="#2040a0">archive_entry</font> <font color="4444FF">*</font><font color="#2040a0">wentry</font>,
		<strong>struct</strong> <font color="#2040a0">archive</font> <font color="4444FF">*</font><font color="#2040a0">newarc</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>struct</strong> <font color="#2040a0">stat</font> <font color="#2040a0">st</font><font color="4444FF">;</font>
		<strong>int</strong> <font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
		<font color="#2040a0">off_t</font> <font color="#2040a0">offset</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
		<strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">buf</font><font color="4444FF">;</font>
		<font color="#2040a0">ssize_t</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
		<font color="#444444">/* copy stat info */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">lstat</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Could not lstat temporary file %s: &quot;</font>,
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>,
					<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">archive_entry_copy_stat</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#444444">/* open temporary file */</font>
		<font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="#2040a0">O_RDONLY</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Fatal error opening modified file %s at &quot;</font>
					<font color="#008000">&quot;location %s, giving up&quot;</font>,
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* write header */</font>
		<font color="#2040a0">archive_write_header</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font>, <font color="#2040a0">wentry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#444444">/* copy data */</font>
		<font color="#2040a0">buf</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">MAXBUF</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>while</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">len</font> <font color="4444FF">=</font> <font color="#2040a0">pread</font><font color="4444FF">(</font> <font color="#2040a0">fh</font>, <font color="#2040a0">buf</font>, <font color="4444FF">(</font> <font color="#2040a0">size_t</font> <font color="4444FF">)</font><font color="#2040a0">MAXBUF</font>,
						<font color="#2040a0">offset</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">&gt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">archive_write_data</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font>, <font color="#2040a0">buf</font>, <font color="#2040a0">len</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">offset</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">buf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">len</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Error reading temporary file %s for file %s: &quot;</font>,
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>,
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>,
					<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* clean up */</font>
		<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">S_ISDIR</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_mode</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">rmdir</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;WARNING: rmdir '%s' failed: %s&quot;</font>,
						<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;WARNING: unlinking '%s' failed: %s&quot;</font>,
						<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* no data, only write header (e.g. when node is a link!) */</font>
		<font color="#444444">/* FIXME: hardlinks are saved, symlinks not. why??? */</font>
		//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;writing header for file %s&quot;</font>, <font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive_write_header</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font>, <font color="#2040a0">wentry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* mark file as written */</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">save</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">archiveFile</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>struct</strong> <font color="#2040a0">archive</font> <font color="4444FF">*</font><font color="#2040a0">oldarc</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">archive</font> <font color="4444FF">*</font><font color="#2040a0">newarc</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">archive_entry</font> <font color="4444FF">*</font><font color="#2040a0">entry</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">tempfile</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">format</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">compression</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="#2040a0">oldfilename</font><font color="4444FF">[</font><font color="#2040a0">PATH_MAX</font><font color="4444FF">]</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="#2040a0">buf</font><font color="4444FF">[</font><font color="#2040a0">PATH_MAX</font><font color="4444FF">]</font><font color="4444FF">;</font>

	<font color="#2040a0">getcwd</font><font color="4444FF">(</font> <font color="#2040a0">buf</font>, <font color="#2040a0">PATH_MAX</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* unfortunately libarchive does not support modification of
	 * compressed archives, so a new archive has to be written */</font>
	<font color="#444444">/* rename old archive */</font>
	<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="#2040a0">oldfilename</font>, <font color="#008000">&quot;%s.orig&quot;</font>, <font color="#2040a0">archiveFile</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">rename</font><font color="4444FF">(</font> <font color="#2040a0">archiveFile</font>, <font color="#2040a0">oldfilename</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>int</strong> <font color="#2040a0">err</font> <font color="4444FF">=</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Could not rename old archive file (%s/%s): %s&quot;</font>,
				<font color="#2040a0">buf</font>, <font color="#2040a0">archiveFile</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">err</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archiveFd</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">archiveFile</font>, <font color="#2040a0">O_RDONLY</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">err</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">archiveFd</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">oldfilename</font>, <font color="#2040a0">O_RDONLY</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* open old archive */</font>
	<font color="#2040a0">oldarc</font> <font color="4444FF">=</font> <font color="#2040a0">archive_read_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_support_compression_all</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_support_format_all</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_open_fd</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font>, <font color="#2040a0">archiveFd</font>, <font color="#FF0000">10240</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">format</font> <font color="4444FF">=</font> <font color="#2040a0">archive_format</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">compression</font> <font color="4444FF">=</font> <font color="#2040a0">archive_compression</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/*
	log( &quot;format of old archive is %s (%d)&quot;,
			archive_format_name( oldarc ),
			format );
	log( &quot;compression of old archive is %s (%d)&quot;,
			archive_compression_name( oldarc ),
			compression );
	*/</font>
	<font color="#444444">/* open new archive */</font>
	<font color="#2040a0">newarc</font> <font color="4444FF">=</font> <font color="#2040a0">archive_write_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>switch</strong><font color="4444FF">(</font> <font color="#2040a0">compression</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>case</strong> <font color="#2040a0">ARCHIVE_COMPRESSION_GZIP</font><font color="4444FF">:</font>
			<font color="#2040a0">archive_write_set_compression_gzip</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>break</strong><font color="4444FF">;</font>
		<strong>case</strong> <font color="#2040a0">ARCHIVE_COMPRESSION_BZIP2</font><font color="4444FF">:</font>
			<font color="#2040a0">archive_write_set_compression_bzip2</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>break</strong><font color="4444FF">;</font>
		<strong>case</strong> <font color="#2040a0">ARCHIVE_COMPRESSION_COMPRESS</font><font color="4444FF">:</font>
		<strong>case</strong> <font color="#2040a0">ARCHIVE_COMPRESSION_NONE</font><font color="4444FF">:</font>
		<strong>default</strong><font color="4444FF">:</font>
			<font color="#2040a0">archive_write_set_compression_none</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>break</strong><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
<font color="0000ff"><strong>#if 0</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_write_set_format</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font>, <font color="#2040a0">format</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOTSUP</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
<font color="0000ff"><strong>#endif</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_CPIO</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_CPIO_POSIX</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_write_set_format_cpio</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;set write format to posix-cpio&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_SHAR</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_SHAR_BASE</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_SHAR_DUMP</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_write_set_format_shar</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;set write format to binary shar&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_TAR_PAX_RESTRICTED</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_write_set_format_pax_restricted</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;set write format to binary pax restricted&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_TAR_PAX_INTERCHANGE</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_write_set_format_pax</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;set write format to binary pax interchange&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_TAR_USTAR</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_TAR</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">&amp;</font> <font color="#2040a0">ARCHIVE_FORMAT_TAR_GNUTAR</font>
			<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">format</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_write_set_format_ustar</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;set write format to ustar&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;writing archives of format %d (%s) is not &quot;</font>
				<font color="#008000">&quot;supported&quot;</font>, <font color="#2040a0">format</font>,
				<font color="#2040a0">archive_format_name</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOTSUP</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">tempfile</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">archiveFile</font>,
			<font color="#2040a0">O_WRONLY</font> <font color="4444FF">|</font> <font color="#2040a0">O_CREAT</font> <font color="4444FF">|</font> <font color="#2040a0">O_EXCL</font>,
			<font color="#2040a0">S_IRUSR</font> <font color="4444FF">|</font> <font color="#2040a0">S_IWUSR</font> <font color="4444FF">|</font> <font color="#2040a0">S_IRGRP</font> <font color="4444FF">|</font> <font color="#2040a0">S_IROTH</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">tempfile</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;could not open new archive file for writing&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_write_open_fd</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font>, <font color="#2040a0">tempfile</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_next_header</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font>, <font color="4444FF">&amp;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">off_t</font> <font color="#2040a0">offset</font><font color="4444FF">;</font>
		<strong>const</strong> <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">buf</font><font color="4444FF">;</font>
		<strong>struct</strong> <font color="#2040a0">archive_entry</font> <font color="4444FF">*</font><font color="#2040a0">wentry</font><font color="4444FF">;</font>
		<font color="#2040a0">size_t</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
		<strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">name</font><font color="4444FF">;</font>
		<font color="#444444">/* find corresponding node */</font>
		<font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_entry</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;WARNING: no such node for '%s'&quot;</font>, <font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_read_data_skip</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>continue</strong><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* create new entry, copy metadata */</font>
		<font color="#2040a0">wentry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_gname_w</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">archive_entry_copy_gname_w</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>,
					<font color="#2040a0">archive_entry_gname_w</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">archive_entry_copy_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>,
					<font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink_w</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">archive_entry_copy_hardlink_w</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>,
					<font color="#2040a0">archive_entry_hardlink_w</font><font color="4444FF">(</font>
						<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">archive_entry_copy_stat</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>,
				<font color="#2040a0">archive_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink_w</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">archive_entry_copy_symlink_w</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>,
					<font color="#2040a0">archive_entry_symlink_w</font><font color="4444FF">(</font>
						<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_uname_w</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">archive_entry_copy_uname_w</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>,
					<font color="#2040a0">archive_entry_uname_w</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* set correct name */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">namechanged</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">name</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font>
						<font color="#2040a0">wentry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font>
						<font color="#2040a0">wentry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>, <font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* write header and copy data */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* file was modified */</font>
			<font color="#2040a0">write_new_modded_file</font><font color="4444FF">(</font> <font color="#2040a0">node</font>, <font color="#2040a0">wentry</font>, <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
			<font color="#444444">/* file was not modified */</font>
			<font color="#2040a0">archive_entry_copy_stat</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font>,
					<font color="#2040a0">archive_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_write_header</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font>, <font color="#2040a0">wentry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_data_block</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font>, <font color="4444FF">&amp;</font><font color="#2040a0">buf</font>,
						<font color="4444FF">&amp;</font><font color="#2040a0">len</font>, <font color="4444FF">&amp;</font><font color="#2040a0">offset</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font>
			<font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">archive_write_data</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font>, <font color="#2040a0">buf</font>, <font color="#2040a0">len</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* clean up */</font>
		<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">wentry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <font color="#444444">/* end: while read next header */</font>
	<font color="#444444">/* find new files to add (those do still have modified flag set */</font>
	<strong>while</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">find_modified_node</font><font color="4444FF">(</font> <font color="#2040a0">root</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">write_new_modded_file</font><font color="4444FF">(</font> <font color="#2040a0">node</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* clean up, re-open the new archive for reading */</font>
	<font color="#2040a0">archive_read_finish</font><font color="4444FF">(</font> <font color="#2040a0">oldarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_write_finish</font><font color="4444FF">(</font> <font color="#2040a0">newarc</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">tempfile</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveFd</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">archiveFile</font>, <font color="#2040a0">O_RDONLY</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>


  <font color="#444444"><i>/*****************/</i></font>
 <font color="#444444">/* API functions */</font>
<font color="#444444"><i>/*****************/</i></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_read</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">buf</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">size</font>, <font color="#2040a0">off_t</font> <font color="#2040a0">offset</font>,
		<strong>struct</strong> <font color="#2040a0">fuse_file_info</font> <font color="4444FF">*</font><font color="#2040a0">fi</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>int</strong> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">realpath</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">fi</font><font color="4444FF">;</font>

	<font color="#444444">/* find node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a hardlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_read</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>,
				<font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#2040a0">offset</font>, <font color="#2040a0">fi</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a symlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_read</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>,
				<font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#2040a0">offset</font>, <font color="#2040a0">fi</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* the file is new or modified, read temporary file instead */</font>
		<strong>int</strong> <font color="#2040a0">fh</font><font color="4444FF">;</font>
		<font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="#2040a0">O_RDONLY</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Fatal error opening modified file '%s' at &quot;</font>
					<font color="#008000">&quot;location '%s', giving up&quot;</font>,
					<font color="#2040a0">path</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* copy data */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">pread</font><font color="4444FF">(</font> <font color="#2040a0">fh</font>, <font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#2040a0">offset</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Error reading temporary file '%s': %s&quot;</font>,
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* clean up */</font>
		<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<strong>struct</strong> <font color="#2040a0">archive</font> <font color="4444FF">*</font><font color="#2040a0">archive</font><font color="4444FF">;</font>
		<strong>struct</strong> <font color="#2040a0">archive_entry</font> <font color="4444FF">*</font><font color="#2040a0">entry</font><font color="4444FF">;</font>
		<font color="#444444">/* search file in archive */</font>
		<font color="#2040a0">realpath</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive</font> <font color="4444FF">=</font> <font color="#2040a0">archive_read_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_support_compression_all</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_support_format_all</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_open_fd</font><font color="4444FF">(</font> <font color="#2040a0">archive</font>, <font color="#2040a0">archiveFd</font>, <font color="#FF0000">10240</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* search for file to read */</font>
		<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">archive_read_next_header</font><font color="4444FF">(</font> <font color="#2040a0">archive</font>, <font color="4444FF">&amp;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_OK</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">name</font><font color="4444FF">;</font>
			<font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">realpath</font>, <font color="#2040a0">name</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">trash</font><font color="4444FF">;</font>
				<font color="#2040a0">trash</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">MAXBUF</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#444444">/* skip offset */</font>
				<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">offset</font> <font color="4444FF">&gt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
					<strong>int</strong> <font color="#2040a0">skip</font> <font color="4444FF">=</font> <font color="#2040a0">offset</font> <font color="4444FF">&gt;</font> <font color="#2040a0">MAXBUF</font> ? <font color="#2040a0">MAXBUF</font> <font color="4444FF">:</font> <font color="#2040a0">offset</font><font color="4444FF">;</font>
					<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">archive_read_data</font><font color="4444FF">(</font>
							<font color="#2040a0">archive</font>, <font color="#2040a0">trash</font>, <font color="#2040a0">skip</font> <font color="4444FF">)</font><font color="4444FF">;</font>
					<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_FATAL</font>
							<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_WARN</font>
							<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_RETRY</font> <font color="4444FF">)</font>
					<font color="4444FF"><strong>{</strong></font>
						<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ar_read (skipping offset): %s&quot;</font>,
							<font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
						<font color="#2040a0">errno</font> <font color="4444FF">=</font> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
						<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
						<strong>break</strong><font color="4444FF">;</font>
					<font color="4444FF"><strong>}</strong></font>
					<font color="#2040a0">offset</font> <font color="4444FF">-</font><font color="4444FF">=</font> <font color="#2040a0">skip</font><font color="4444FF">;</font>
				<font color="4444FF"><strong>}</strong></font>
				<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">trash</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">offset</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
					<font color="#444444">/* there was an error */</font>
					<strong>break</strong><font color="4444FF">;</font>
				<font color="4444FF"><strong>}</strong></font>
				<font color="#444444">/* read data */</font>
				<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">archive_read_data</font><font color="4444FF">(</font> <font color="#2040a0">archive</font>, <font color="#2040a0">buf</font>, <font color="#2040a0">size</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_FATAL</font>
						<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_WARN</font>
						<font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ARCHIVE_RETRY</font> <font color="4444FF">)</font>
				<font color="4444FF"><strong>{</strong></font>
					<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ar_read (reading data): %s&quot;</font>,
						<font color="#2040a0">archive_error_string</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
					<font color="#2040a0">errno</font> <font color="4444FF">=</font> <font color="#2040a0">archive_errno</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
					<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">;</font>
					<strong>break</strong><font color="4444FF">;</font>
				<font color="4444FF"><strong>}</strong></font>
			<font color="4444FF"><strong>}</strong></font>
			<font color="#2040a0">archive_read_data_skip</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* close archive */</font>
		<font color="#2040a0">archive_read_finish</font><font color="4444FF">(</font> <font color="#2040a0">archive</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">lseek</font><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font>, <font color="#FF0000">0</font>, <font color="#2040a0">SEEK_SET</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_getattr</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>struct</strong> <font color="#2040a0">stat</font> <font color="4444FF">*</font><font color="#2040a0">stbuf</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>

	//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;getattr got path: '%s'<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a hardlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_getattr</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font>
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>, <font color="#2040a0">stbuf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">memcpy</font><font color="4444FF">(</font> <font color="#2040a0">stbuf</font>,
			<font color="#2040a0">archive_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>,
			<strong>sizeof</strong><font color="4444FF">(</font> <strong>struct</strong> <font color="#2040a0">stat</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444">/*
 * mkdir is nearly identical to mknod...
 */</font>
<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_mkdir</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <font color="#2040a0">mode_t</font> <font color="#2040a0">mode</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">location</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* check for existing node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EEXIST</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* create name for temp file */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">get_temp_file_name</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="4444FF">&amp;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* create temp file */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">mkdir</font><font color="4444FF">(</font> <font color="#2040a0">location</font>, <font color="#2040a0">mode</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Could not create temporary dir %s: %s&quot;</font>,
				<font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* build node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <strong>sizeof</strong><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="#2040a0">location</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">namechanged</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="#444444">/* build entry */</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>
			<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>
			<font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">update_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;mknod: error stat'ing dir %s: %s&quot;</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>,
				<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">tmp</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">rmdir</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* add node to tree */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR: could not insert %s into tree&quot;</font>,
				<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">rmdir</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* clean up */</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444">/*
 * ar_rmdir is called for directories only and does not need to do any
 * recursive stuff
 */</font>
<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_rmdir</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOTEMPTY</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">[</font><font color="#2040a0">strlen</font><font color="4444FF">(</font><font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">)</font><font color="4444FF">-</font><font color="#FF0000">1</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'.'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EINVAL</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">S_ISDIR</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOTDIR</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* remove temp directory */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">rmdir</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>int</strong> <font color="#2040a0">err</font> <font color="4444FF">=</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR: removing temp directory %s failed: %s&quot;</font>,
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">err</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#2040a0">err</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">remove_child</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_symlink</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">from</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">to</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">stat</font> <font color="#2040a0">st</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">passwd</font> <font color="4444FF">*</font><font color="#2040a0">pwd</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">group</font> <font color="4444FF">*</font><font color="#2040a0">grp</font><font color="4444FF">;</font>

	<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOSYS</font><font color="4444FF">;</font> <font color="#444444">/* somehow saving symlinks does not work. The code below is ok.. see write_new_modded_file() */</font>
	<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;symlink called, %s -&gt; %s&quot;</font>, <font color="#2040a0">from</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* check for existing node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EEXIST</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* build node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <strong>sizeof</strong><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<font color="#444444">/* build stat info */</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_dev</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_ino</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_mode</font> <font color="4444FF">=</font> <font color="#2040a0">S_IFLNK</font> <font color="4444FF">|</font> <font color="#2040a0">S_IRWXU</font> <font color="4444FF">|</font> <font color="#2040a0">S_IRWXG</font> <font color="4444FF">|</font> <font color="#2040a0">S_IRWXO</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_nlink</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_uid</font> <font color="4444FF">=</font> <font color="#2040a0">getuid</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_gid</font> <font color="4444FF">=</font> <font color="#2040a0">getgid</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_rdev</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_size</font> <font color="4444FF">=</font> <font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">from</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_blksize</font> <font color="4444FF">=</font> <font color="#FF0000">4096</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_blocks</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<font color="#2040a0">st</font>.<font color="#2040a0">st_atime</font> <font color="4444FF">=</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_ctime</font> <font color="4444FF">=</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_mtime</font> <font color="4444FF">=</font> <font color="#2040a0">time</font><font color="4444FF">(</font> <font color="#2040a0">NULL</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* build entry */</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>
			<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>
			<font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">archive_entry_copy_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">from</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* get user/group name */</font>
	<font color="#2040a0">pwd</font> <font color="4444FF">=</font> <font color="#2040a0">getpwuid</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_uid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">pwd</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* a name was found for the uid */</font>
		<font color="#2040a0">archive_entry_set_uname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">pwd</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">pw_name</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EINTR</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EIO</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EMFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> 
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENOMEM</font> <font color="4444FF">|</font><font color="4444FF">|</font>
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ERANGE</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR calling getpwuid: %s&quot;</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* on other errors the uid just could
		   not be resolved into a name */</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">grp</font> <font color="4444FF">=</font> <font color="#2040a0">getgrgid</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_gid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">grp</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* a name was found for the uid */</font>
		<font color="#2040a0">archive_entry_set_gname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">grp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">gr_name</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EINTR</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EIO</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EMFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> 
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENOMEM</font> <font color="4444FF">|</font><font color="4444FF">|</font>
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ERANGE</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR calling getgrgid: %s&quot;</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* on other errors the gid just could
		   not be resolved into a name */</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* add node to tree */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR: could not insert symlink %s into tree&quot;</font>,
				<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* clean up */</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_link</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">from</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">to</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">fromnode</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">stat</font> <font color="#2040a0">st</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">passwd</font> <font color="4444FF">*</font><font color="#2040a0">pwd</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">group</font> <font color="4444FF">*</font><font color="#2040a0">grp</font><font color="4444FF">;</font>

	//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;hardlink called, %s -&gt; %s&quot;</font>, <font color="#2040a0">from</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* find source node */</font>
	<font color="#2040a0">fromnode</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">from</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">fromnode</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* check for existing target */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EEXIST</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* extract originals stat info */</font>
	<font color="#2040a0">ar_getattr</font><font color="4444FF">(</font> <font color="#2040a0">from</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* build new node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <strong>sizeof</strong><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<font color="#444444">/* build entry */</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>
			<font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">fromnode</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">archive_entry_copy_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">from</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* get user/group name */</font>
	<font color="#2040a0">pwd</font> <font color="4444FF">=</font> <font color="#2040a0">getpwuid</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_uid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">pwd</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* a name was found for the uid */</font>
		<font color="#2040a0">archive_entry_set_uname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">pwd</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">pw_name</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EINTR</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EIO</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EMFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> 
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENOMEM</font> <font color="4444FF">|</font><font color="4444FF">|</font>
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ERANGE</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR calling getpwuid: %s&quot;</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* on other errors the uid just could
		   not be resolved into a name */</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">grp</font> <font color="4444FF">=</font> <font color="#2040a0">getgrgid</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_gid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">grp</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* a name was found for the uid */</font>
		<font color="#2040a0">archive_entry_set_gname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">grp</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">gr_name</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EINTR</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EIO</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">EMFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> 
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENFILE</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ENOMEM</font> <font color="4444FF">|</font><font color="4444FF">|</font>
				<font color="#2040a0">errno</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#2040a0">ERANGE</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR calling getgrgid: %s&quot;</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* on other errors the gid just could
		   not be resolved into a name */</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* add node to tree */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR: could not insert hardlink %s into tree&quot;</font>,
				<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* clean up */</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_truncate</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <font color="#2040a0">off_t</font> <font color="#2040a0">size</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">location</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">fh</font><font color="4444FF">;</font>

	//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;truncate called&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a hardlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_truncate</font><font color="4444FF">(</font>
				<font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>, <font color="#2040a0">size</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a symlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_truncate</font><font color="4444FF">(</font>
				<font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>, <font color="#2040a0">size</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* open existing temp file */</font>
		<font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">location</font>, <font color="#2040a0">O_WRONLY</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;error opening temp file %s: %s&quot;</font>,
					<font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* create new temp file */</font>
		<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">tmpbuf</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
		<strong>int</strong> <font color="#2040a0">tmpoffset</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
		<font color="#2040a0">int64_t</font> <font color="#2040a0">tmpsize</font><font color="4444FF">;</font>
		<strong>struct</strong> <font color="#2040a0">fuse_file_info</font> <font color="#2040a0">fi</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">get_temp_file_name</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="4444FF">&amp;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">location</font>, <font color="#2040a0">O_WRONLY</font> <font color="4444FF">|</font> <font color="#2040a0">O_CREAT</font> <font color="4444FF">|</font> <font color="#2040a0">O_EXCL</font>,
				<font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;error opening temp file %s: %s&quot;</font>,
					<font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* copy original file to temporary file */</font>
		<font color="#2040a0">tmpsize</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_size</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">tmpbuf</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <strong>char</strong> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">MAXBUF</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">tmpsize</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>int</strong> <font color="#2040a0">len</font> <font color="4444FF">=</font> <font color="#2040a0">tmpsize</font> <font color="4444FF">&gt;</font> <font color="#2040a0">MAXBUF</font> ? <font color="#2040a0">MAXBUF</font> <font color="4444FF">:</font> <font color="#2040a0">tmpsize</font><font color="4444FF">;</font>
			<font color="#444444">/* read */</font>
			<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">ar_read</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="#2040a0">tmpbuf</font>, <font color="#2040a0">len</font>, <font color="#2040a0">tmpoffset</font>, <font color="4444FF">&amp;</font><font color="#2040a0">fi</font> <font color="4444FF">)</font> <font color="4444FF">)</font>
					<font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
			<font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR reading while copying %s to &quot;</font>
						<font color="#008000">&quot;temporary location %s: %s&quot;</font>,
						<font color="#2040a0">path</font>, <font color="#2040a0">location</font>,
						<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">tmp</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">tmpbuf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
			<font color="#444444">/* write */</font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">write</font><font color="4444FF">(</font> <font color="#2040a0">fh</font>, <font color="#2040a0">tmpbuf</font>, <font color="#2040a0">tmp</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
				<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR writing while copying %s to &quot;</font>
					       <font color="#008000">&quot;temporary location %s: %s&quot;</font>,
						<font color="#2040a0">path</font>, <font color="#2040a0">location</font>,
						<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">tmpbuf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
			<font color="#2040a0">tmpsize</font> <font color="4444FF">-</font><font color="4444FF">=</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
			<font color="#2040a0">tmpoffset</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">tmpoffset</font> <font color="4444FF">&gt;</font><font color="4444FF">=</font> <font color="#2040a0">size</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<font color="#444444">/* copied enough, exit the loop */</font>
				<strong>break</strong><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* clean up */</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">tmpbuf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">lseek</font><font color="4444FF">(</font> <font color="#2040a0">fh</font>, <font color="#FF0000">0</font>, <font color="#2040a0">SEEK_SET</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* truncate temporary file */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">truncate</font><font color="4444FF">(</font> <font color="#2040a0">location</font>, <font color="#2040a0">size</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR truncating %s (temporary location %s): %s&quot;</font>,
				<font color="#2040a0">path</font>, <font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* record location, update entry */</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="#2040a0">location</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">update_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;write: error stat'ing file %s: %s&quot;</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>,
				<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">tmp</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* clean up */</font>
	<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_write</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">buf</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">size</font>,
		<font color="#2040a0">off_t</font> <font color="#2040a0">offset</font>, <strong>struct</strong> <font color="#2040a0">fuse_file_info</font> <font color="4444FF">*</font><font color="#2040a0">fi</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">location</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">fh</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">S_ISLNK</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a symlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_write</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>,
				<font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#2040a0">offset</font>, <font color="#2040a0">fi</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a hardlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_write</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>,
				<font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#2040a0">offset</font>, <font color="#2040a0">fi</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a symlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_write</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>,
				<font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#2040a0">offset</font>, <font color="#2040a0">fi</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* open existing temp file */</font>
		<font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">location</font>, <font color="#2040a0">O_WRONLY</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;error opening temp file %s: %s&quot;</font>,
					<font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* create new temp file */</font>
		<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">tmpbuf</font> <font color="4444FF">=</font> <font color="#2040a0">NULL</font><font color="4444FF">;</font>
		<strong>int</strong> <font color="#2040a0">tmpoffset</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
		<font color="#2040a0">int64_t</font> <font color="#2040a0">tmpsize</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">get_temp_file_name</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="4444FF">&amp;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">location</font>, <font color="#2040a0">O_WRONLY</font> <font color="4444FF">|</font> <font color="#2040a0">O_CREAT</font> <font color="4444FF">|</font> <font color="#2040a0">O_EXCL</font>,
				<font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font>
		<font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;error opening temp file %s: %s&quot;</font>,
					<font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* copy original file to temporary file */</font>
		<font color="#2040a0">tmpsize</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_size</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">tmpbuf</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <strong>char</strong> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">MAXBUF</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">tmpsize</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>int</strong> <font color="#2040a0">len</font> <font color="4444FF">=</font> <font color="#2040a0">tmpsize</font> <font color="4444FF">&gt;</font> <font color="#2040a0">MAXBUF</font> ? <font color="#2040a0">MAXBUF</font> <font color="4444FF">:</font> <font color="#2040a0">tmpsize</font><font color="4444FF">;</font>
			<font color="#444444">/* read */</font>
			<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">ar_read</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="#2040a0">tmpbuf</font>, <font color="#2040a0">len</font>, <font color="#2040a0">tmpoffset</font>, <font color="#2040a0">fi</font> <font color="4444FF">)</font> <font color="4444FF">)</font>
					<font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
			<font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR reading while copying %s to &quot;</font>
						<font color="#008000">&quot;temporary location %s: %s&quot;</font>,
						<font color="#2040a0">path</font>, <font color="#2040a0">location</font>,
						<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">tmp</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">tmpbuf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
			<font color="#444444">/* write */</font>
			<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">write</font><font color="4444FF">(</font> <font color="#2040a0">fh</font>, <font color="#2040a0">tmpbuf</font>, <font color="#2040a0">len</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
				<font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
				<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR writing while copying %s to &quot;</font>
					       <font color="#008000">&quot;temporary location %s: %s&quot;</font>,
						<font color="#2040a0">path</font>, <font color="#2040a0">location</font>,
						<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">tmpbuf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
				<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
			<font color="4444FF"><strong>}</strong></font>
			<font color="#2040a0">tmpsize</font> <font color="4444FF">-</font><font color="4444FF">=</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
			<font color="#2040a0">tmpoffset</font> <font color="4444FF">+</font><font color="4444FF">=</font> <font color="#2040a0">len</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#444444">/* clean up */</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">tmpbuf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">lseek</font><font color="4444FF">(</font> <font color="#2040a0">fh</font>, <font color="#FF0000">0</font>, <font color="#2040a0">SEEK_SET</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* write changes to temporary file */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">pwrite</font><font color="4444FF">(</font> <font color="#2040a0">fh</font>, <font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#2040a0">offset</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR writing changes to %s (temporary &quot;</font>
				<font color="#008000">&quot;location %s): %s&quot;</font>,
				<font color="#2040a0">path</font>, <font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* record location, update entry */</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="#2040a0">location</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">update_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;write: error stat'ing file %s: %s&quot;</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>,
				<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">tmp</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* clean up */</font>
	<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">fh</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_mknod</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <font color="#2040a0">mode_t</font> <font color="#2040a0">mode</font>, <font color="#2040a0">dev_t</font> <font color="#2040a0">rdev</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">location</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>

	//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;mknod called, %s&quot;</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* check for existing node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EEXIST</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* create name for temp file */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">get_temp_file_name</font><font color="4444FF">(</font> <font color="#2040a0">path</font>, <font color="4444FF">&amp;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* create temp file */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">mknod</font><font color="4444FF">(</font> <font color="#2040a0">location</font>, <font color="#2040a0">mode</font>, <font color="#2040a0">rdev</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;Could not create temporary file %s: %s&quot;</font>,
				<font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* build node */</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">*</font> <font color="4444FF">)</font><font color="#2040a0">malloc</font><font color="4444FF">(</font> <strong>sizeof</strong><font color="4444FF">(</font> <font color="#2040a0">NODE</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">init_node</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">=</font> <font color="#2040a0">location</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#444444">/* build entry */</font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_new</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>
			<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font>
			<font color="#2040a0">archive_entry_pathname</font><font color="4444FF">(</font> <font color="#2040a0">root</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">[</font><font color="#FF0000">0</font><font color="4444FF">]</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">+</font> <font color="#FF0000">1</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archive_entry_set_pathname</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">(</font> <font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">update_entry_stat</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">&lt;</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;mknod: error stat'ing file %s: %s&quot;</font>, <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>,
				<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#FF0000">0</font> <font color="4444FF">-</font> <font color="#2040a0">tmp</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">tmp</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* add node to tree */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR: could not insert %s into tree&quot;</font>,
				<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">archive_entry_free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* clean up */</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_unlink</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">S_ISDIR</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EISDIR</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* remove temporary file */</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">unlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>int</strong> <font color="#2040a0">err</font> <font color="4444FF">=</font> <font color="#2040a0">errno</font><font color="4444FF">;</font>
			<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;ERROR: could not unlink temporary file '%s'&quot;</font>,
					<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font>, <font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">errno</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
			<strong>return</strong> <font color="#2040a0">err</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
		<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">location</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">remove_child</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_chmod</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <font color="#2040a0">mode_t</font> <font color="#2040a0">mode</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a hardlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_chmod</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>, <font color="#2040a0">mode</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a symlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_chmod</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>, <font color="#2040a0">mode</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">archive_entry_set_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">mode</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_chown</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <font color="#2040a0">uid_t</font> <font color="#2040a0">uid</font>, <font color="#2040a0">gid_t</font> <font color="#2040a0">gid</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a hardlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_chown</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>,
				<font color="#2040a0">uid</font>, <font color="#2040a0">gid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* changing ownership of symlinks is allowed, however */</font>
	<font color="#2040a0">archive_entry_set_uid</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">uid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_gid</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">gid</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_utime</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>struct</strong> <font color="#2040a0">utimbuf</font> <font color="4444FF">*</font><font color="#2040a0">buf</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>

	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a hardlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_utime</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_hardlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>, <font color="#2040a0">buf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* file is a symlink, recurse into it */</font>
		<strong>return</strong> <font color="#2040a0">ar_utime</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font>, <font color="#2040a0">buf</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">archive_entry_set_mtime</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">buf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">modtime</font>, <font color="#FF0000">0</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archive_entry_set_atime</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font>, <font color="#2040a0">buf</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">actime</font>, <font color="#FF0000">0</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_statfs</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>struct</strong> <font color="#2040a0">statfs</font> <font color="4444FF">*</font><font color="#2040a0">stbuf</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#444444">/* ENOSYS is ok for this, we have no statistics */</font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">path</font><font color="4444FF">;</font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">stbuf</font><font color="4444FF">;</font>

	<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOSYS</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_rename</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">from</font>, <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">to</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>

	//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;&gt;&gt;ar_rename: got from: '%s', to: '%s'&quot;</font>, <font color="#2040a0">from</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">from</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* it is a directory, recursive change of all nodes
		 * below it is required */</font>
		<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">rename_recursively</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font>, <font color="#2040a0">from</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* meta data is changed in save() */</font>
	<font color="#444444">/* change node name */</font>
	<font color="#2040a0">free</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">*</font><font color="#2040a0">to</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">malloc</font><font color="4444FF">(</font> <font color="#2040a0">strlen</font><font color="4444FF">(</font> <font color="#2040a0">to</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">2</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">sprintf</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">&quot;/%s&quot;</font>, <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font> <strong>else</strong> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strdup</font><font color="4444FF">(</font> <font color="#2040a0">to</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">namechanged</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<font color="#2040a0">remove_child</font><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">ret</font> <font color="4444FF">=</font> <font color="#2040a0">insert_by_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">node</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveModified</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#2040a0">ret</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_fsync</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>int</strong> <font color="#2040a0">isdatasync</font>, <strong>struct</strong> <font color="#2040a0">fuse_file_info</font> <font color="4444FF">*</font><font color="#2040a0">fi</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#444444">/* Just a stub.  This method is optional and can safely be left
	   unimplemented */</font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">path</font><font color="4444FF">;</font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">isdatasync</font><font color="4444FF">;</font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">fi</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_readlink</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">buf</font>, <font color="#2040a0">size_t</font> <font color="#2040a0">size</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">tmp</font><font color="4444FF">;</font>

	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">S_ISLNK</font><font color="4444FF">(</font> <font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOLINK</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">tmp</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_symlink</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">snprintf</font><font color="4444FF">(</font> <font color="#2040a0">buf</font>, <font color="#2040a0">size</font>, <font color="#008000">&quot;%s&quot;</font>, <font color="#2040a0">tmp</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_open</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>struct</strong> <font color="#2040a0">fuse_file_info</font> <font color="4444FF">*</font><font color="#2040a0">fi</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>

	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">fi</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">flags</font> <font color="4444FF">&amp;</font> <font color="#2040a0">O_WRONLY</font> <font color="4444FF">|</font><font color="4444FF">|</font> <font color="#2040a0">fi</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">flags</font> <font color="4444FF">&amp;</font> <font color="#2040a0">O_RDWR</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">EROFS</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* no need to recurse into links since function doesn't do anything */</font>
	<font color="#444444">/* no need to save a handle here since archives are stream based */</font>
	<font color="#2040a0">fi</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">fh</font> <font color="4444FF">=</font> <font color="#FF0000">0</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_release</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>struct</strong> <font color="#2040a0">fuse_file_info</font> <font color="4444FF">*</font><font color="#2040a0">fi</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">fi</font><font color="4444FF">;</font>
	<font color="4444FF">(</font> <strong>void</strong> <font color="4444FF">)</font><font color="#2040a0">path</font><font color="4444FF">;</font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>int</strong>
<font color="#2040a0">ar_readdir</font><font color="4444FF">(</font> <strong>const</strong> <strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">path</font>, <strong>void</strong> <font color="4444FF">*</font><font color="#2040a0">buf</font>, <font color="#2040a0">fuse_fill_dir_t</font> <font color="#2040a0">filler</font>,
		<font color="#2040a0">off_t</font> <font color="#2040a0">offset</font>, <strong>struct</strong> <font color="#2040a0">fuse_file_info</font> <font color="4444FF">*</font><font color="#2040a0">fi</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">NODE</font> <font color="4444FF">*</font><font color="#2040a0">node</font><font color="4444FF">;</font>
	<font color="4444FF">(</font><strong>void</strong><font color="4444FF">)</font> <font color="#2040a0">offset</font><font color="4444FF">;</font>
	<font color="4444FF">(</font><strong>void</strong><font color="4444FF">)</font> <font color="#2040a0">fi</font><font color="4444FF">;</font>

	//<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;readdir got path: '%s'&quot;</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">get_node_for_path</font><font color="4444FF">(</font> <font color="#2040a0">root</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">log</font><font color="4444FF">(</font> <font color="#008000">&quot;path '%s' not found&quot;</font>, <font color="#2040a0">path</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="4444FF">-</font><font color="#2040a0">ENOENT</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>

	<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">child</font><font color="4444FF">;</font>
	<strong>while</strong><font color="4444FF">(</font> <font color="#2040a0">node</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>struct</strong> <font color="#2040a0">stat</font> <font color="#2040a0">st</font><font color="4444FF">;</font>
		<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">name</font><font color="4444FF">;</font>
		<font color="#2040a0">st</font>.<font color="#2040a0">st_ino</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_ino</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">st</font>.<font color="#2040a0">st_mode</font> <font color="4444FF">=</font> <font color="#2040a0">archive_entry_mode</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">entry</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">name</font> <font color="4444FF">=</font> <font color="#2040a0">strrchr</font><font color="4444FF">(</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">name</font>, <font color="#008000">'/'</font> <font color="4444FF">)</font> <font color="4444FF">+</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">filler</font><font color="4444FF">(</font> <font color="#2040a0">buf</font>, <font color="#2040a0">name</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font>, <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF">)</font>
			<strong>break</strong><font color="4444FF">;</font>
		<font color="#2040a0">node</font> <font color="4444FF">=</font> <font color="#2040a0">node</font><font color="4444FF">-</font><font color="4444FF">&gt;</font><font color="#2040a0">next</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>return</strong> <font color="#FF0000">0</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>static</strong> <strong>struct</strong> <font color="#2040a0">fuse_operations</font> <font color="#2040a0">ar_oper</font> <font color="4444FF">=</font> <font color="4444FF"><strong>{</strong></font>
	.<font color="#2040a0">getattr</font>	<font color="4444FF">=</font> <font color="#2040a0">ar_getattr</font>,
	.<font color="#2040a0">readlink</font>	<font color="4444FF">=</font> <font color="#2040a0">ar_readlink</font>,
	.<font color="#2040a0">readdir</font>	<font color="4444FF">=</font> <font color="#2040a0">ar_readdir</font>,
	.<font color="#2040a0">mknod</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_mknod</font>,
	.<font color="#2040a0">mkdir</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_mkdir</font>,
	.<font color="#2040a0">symlink</font>	<font color="4444FF">=</font> <font color="#2040a0">ar_symlink</font>,
	.<font color="#2040a0">unlink</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_unlink</font>,
	.<font color="#2040a0">rmdir</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_rmdir</font>,
	.<font color="#2040a0">rename</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_rename</font>,
	.<font color="#2040a0">link</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_link</font>,
	.<font color="#2040a0">chmod</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_chmod</font>,
	.<font color="#2040a0">chown</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_chown</font>,
	.<font color="#2040a0">truncate</font>	<font color="4444FF">=</font> <font color="#2040a0">ar_truncate</font>,
	.<font color="#2040a0">utime</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_utime</font>,
	.<font color="#2040a0">open</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_open</font>,
	.<font color="#2040a0">read</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_read</font>,
	.<font color="#2040a0">write</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_write</font>,
	.<font color="#2040a0">statfs</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_statfs</font>,
	.<font color="#2040a0">release</font>	<font color="4444FF">=</font> <font color="#2040a0">ar_release</font>,
	.<font color="#2040a0">fsync</font>		<font color="4444FF">=</font> <font color="#2040a0">ar_fsync</font>,
<font color="#444444">/*
#ifdef HAVE_SETXATTR
	.setxattr	= xmp_setxattr,
	.getxattr	= xmp_getxattr,
	.listxattr	= xmp_listxattr,
	.removexattr	= xmp_removexattr,
#endif
*/</font>
<font color="4444FF"><strong>}</strong></font><font color="4444FF">;</font>

<strong>void</strong>
<font color="#2040a0">showUsage</font><font color="4444FF">(</font><font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">stderr</font>, <font color="#008000">&quot;Usage: archivemount &lt;fuse-options&gt; &lt;archive&gt; &lt;mountpoint&gt;<font color="#77dd77">\n</font>&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">stderr</font>, <font color="#008000">&quot;Usage:              (-v|--version)<font color="#77dd77">\n</font>&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<strong>int</strong>
<font color="#2040a0">main</font><font color="4444FF">(</font> <strong>int</strong> <font color="#2040a0">argc</font>, <strong>char</strong> <font color="4444FF">*</font><font color="4444FF">*</font><font color="#2040a0">argv</font> <font color="4444FF">)</font>
<font color="4444FF"><strong>{</strong></font>
	<strong>int</strong> <font color="#2040a0">fuse_ret</font><font color="4444FF">;</font>
	<strong>struct</strong> <font color="#2040a0">stat</font> <font color="#2040a0">st</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">mtpt</font><font color="4444FF">;</font>
	<strong>char</strong> <font color="4444FF">*</font><font color="#2040a0">archiveFile</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">oldpwd</font><font color="4444FF">;</font>
	<strong>int</strong> <font color="#2040a0">argi</font> <font color="4444FF">=</font> <font color="#2040a0">argc</font><font color="4444FF">;</font>

	<font color="#444444">/* parse cmdline args */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">argc</font> <font color="4444FF">&lt;</font> <font color="#FF0000">2</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">showUsage</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">exit</font><font color="4444FF">(</font> <font color="#2040a0">EXIT_FAILURE</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#FF0000">1</font><font color="4444FF">]</font>, <font color="#008000">&quot;-v&quot;</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">|</font><font color="4444FF">|</font>
			<font color="#2040a0">strcmp</font><font color="4444FF">(</font> <font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#FF0000">1</font><font color="4444FF">]</font>, <font color="#008000">&quot;--version&quot;</font> <font color="4444FF">)</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font>
	<font color="4444FF"><strong>{</strong></font>
		<font color="#444444">/* print version information and exit */</font>
		<font color="#2040a0">printf</font><font color="4444FF">(</font> <font color="#008000">&quot;%d.%d.%d<font color="#77dd77">\n</font>&quot;</font>, <font color="#2040a0">VER_MAJOR</font>, <font color="#2040a0">VER_MINOR</font>, <font color="#2040a0">VER_RELEASE</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">EXIT_SUCCESS</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">argc</font> <font color="4444FF">&lt;</font> <font color="#FF0000">3</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">showUsage</font><font color="4444FF">(</font><font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">exit</font><font color="4444FF">(</font> <font color="#2040a0">EXIT_FAILURE</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">argi</font><font color="4444FF">-</font><font color="4444FF">-</font><font color="4444FF">;</font>
	<font color="#2040a0">mtpt</font> <font color="4444FF">=</font> <font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#2040a0">argi</font><font color="4444FF">]</font><font color="4444FF">;</font>
	<font color="#2040a0">argi</font><font color="4444FF">-</font><font color="4444FF">-</font><font color="4444FF">;</font>
	<font color="#2040a0">archiveFile</font> <font color="4444FF">=</font> <font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#2040a0">argi</font><font color="4444FF">]</font><font color="4444FF">;</font>
	<font color="#2040a0">argv</font><font color="4444FF">[</font><font color="#2040a0">argi</font><font color="4444FF">]</font> <font color="4444FF">=</font> <font color="#2040a0">mtpt</font><font color="4444FF">;</font>

	<font color="#444444">/* check if mtpt is ok and writeable */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">stat</font><font color="4444FF">(</font> <font color="#2040a0">mtpt</font>, <font color="4444FF">&amp;</font><font color="#2040a0">st</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">perror</font><font color="4444FF">(</font> <font color="#008000">&quot;Error stat'ing mountpoint&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">exit</font><font color="4444FF">(</font> <font color="#2040a0">EXIT_FAILURE</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<strong>if</strong><font color="4444FF">(</font> <font color="4444FF">!</font> <font color="#2040a0">S_ISDIR</font><font color="4444FF">(</font> <font color="#2040a0">st</font>.<font color="#2040a0">st_mode</font> <font color="4444FF">)</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">stderr</font>, <font color="#008000">&quot;Problem with mountpoint: %s<font color="#77dd77">\n</font>&quot;</font>,
				<font color="#2040a0">strerror</font><font color="4444FF">(</font> <font color="#2040a0">ENOTDIR</font> <font color="4444FF">)</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="#2040a0">exit</font><font color="4444FF">(</font> <font color="#2040a0">EXIT_FAILURE</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>

	<font color="#444444">/* check if archive is writeable */</font>
	<font color="#2040a0">archiveFd</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">archiveFile</font>, <font color="#2040a0">O_RDWR</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">archiveWriteable</font> <font color="4444FF">=</font> <font color="#FF0000">1</font><font color="4444FF">;</font>
		<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#444444">/* open archive and read meta data */</font>
	<font color="#2040a0">archiveFd</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#2040a0">archiveFile</font>, <font color="#2040a0">O_RDONLY</font> <font color="4444FF">)</font><font color="4444FF">;</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font> <font color="4444FF">=</font><font color="4444FF">=</font> <font color="4444FF">-</font><font color="#FF0000">1</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<font color="#2040a0">perror</font><font color="4444FF">(</font> <font color="#008000">&quot;opening archive failed&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<strong>return</strong> <font color="#2040a0">EXIT_FAILURE</font><font color="4444FF">;</font>
	<font color="4444FF"><strong>}</strong></font>
	<font color="#2040a0">build_tree</font><font color="4444FF">(</font> <font color="#2040a0">mtpt</font> <font color="4444FF">)</font><font color="4444FF">;</font>

	<font color="#444444">/* save directory this was started from */</font>
	<font color="#2040a0">oldpwd</font> <font color="4444FF">=</font> <font color="#2040a0">open</font><font color="4444FF">(</font> <font color="#008000">&quot;.&quot;</font>, <font color="#FF0000">0</font> <font color="4444FF">)</font><font color="4444FF">;</font>

	<font color="#444444">/* now do the real mount */</font>
	<font color="#2040a0">fuse_ret</font> <font color="4444FF">=</font> <font color="#2040a0">fuse_main</font><font color="4444FF">(</font> <font color="#2040a0">argc</font> <font color="4444FF">-</font> <font color="#FF0000">1</font>, <font color="#2040a0">argv</font>, <font color="4444FF">&amp;</font><font color="#2040a0">ar_oper</font> <font color="4444FF">)</font><font color="4444FF">;</font>

	<font color="#444444">/* go back to saved dir */</font>
	<font color="#2040a0">fchdir</font><font color="4444FF">(</font> <font color="#2040a0">oldpwd</font> <font color="4444FF">)</font><font color="4444FF">;</font>

	<font color="#444444">/* save changes if modified */</font>
	<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">archiveWriteable</font> <font color="4444FF">&amp;</font><font color="4444FF">&amp;</font> <font color="#2040a0">archiveModified</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
		<strong>if</strong><font color="4444FF">(</font> <font color="#2040a0">save</font><font color="4444FF">(</font> <font color="#2040a0">archiveFile</font> <font color="4444FF">)</font> <font color="4444FF">!</font><font color="4444FF">=</font> <font color="#FF0000">0</font> <font color="4444FF">)</font> <font color="4444FF"><strong>{</strong></font>
			<font color="#2040a0">fprintf</font><font color="4444FF">(</font> <font color="#2040a0">stderr</font>, <font color="#008000">&quot;Saving new archive failed<font color="#77dd77">\n</font>&quot;</font> <font color="4444FF">)</font><font color="4444FF">;</font>
		<font color="4444FF"><strong>}</strong></font>
	<font color="4444FF"><strong>}</strong></font>

	<font color="#444444">/* clean up */</font>
	<font color="#2040a0">close</font><font color="4444FF">(</font> <font color="#2040a0">archiveFd</font> <font color="4444FF">)</font><font color="4444FF">;</font>

	<strong>return</strong> <font color="#2040a0">EXIT_SUCCESS</font><font color="4444FF">;</font>
<font color="4444FF"><strong>}</strong></font>

<font color="#444444">/*
vim:ts=8:softtabstop=8:sw=8:noexpandtab
*/</font>


</pre>
<hr>
syntax highlighted by <a href="http://www.palfrader.org/code2html">Code2HTML</a>, v. 0.9.1
</body>
</html>
